import pandas as pd
from shapely.geometry import Point
from shapely.wkt import loads
import geopandas as gpd


datadumm = pd.read_csv("data_mediciones_con_dummies")
data_limites_subcuencas = gpd.read_file('LIMITES_SUBCUENCAS_.csv')
data_limites_cuencas = gpd.read_file('TRAMOS_DE_CUENCA.csv')

data_limites_subcuencas['geometry_subcuencas'] = data_limites_subcuencas['wkb_geometry'].apply(lambda x: loads(x))
data_limites_cuencas['geometry_cuencas'] = data_limites_cuencas['wkb_geometry'].apply(lambda x: loads(x))

datadumm['geometry'] = datadumm.apply(lambda row: Point(float(row['Longitud'].replace(',', '.')), float(row['Latitud'].replace(',', '.'))), axis=1)
datadumm = gpd.GeoDataFrame(datadumm, geometry='geometry')

geo_df_subcuencas = gpd.GeoDataFrame(data_limites_subcuencas, geometry=data_limites_subcuencas['geometry_subcuencas'])
geo_df_cuencas = gpd.GeoDataFrame(data_limites_cuencas, geometry=data_limites_cuencas['geometry_cuencas'])


def encontrar_subcuenca(point, subcuencas_gdf):
    for idx, subcuenca in subcuencas_gdf.iterrows():
        if point.within(subcuenca['geometry_subcuencas']):
            return subcuenca['ID']  
    return None

def encontrar_cuenca(point, cuencas_gdf):
    for idx, cuenca in cuencas_gdf.iterrows():
        if point.within(cuenca['geometry_cuencas']):
            return cuenca['TRAMO']  
    return None

datadumm['Subcuenca'] = datadumm['geometry'].apply(lambda x: encontrar_subcuenca(x, geo_df_subcuencas))

datadumm['Cuenca'] = datadumm['geometry'].apply(lambda x: encontrar_cuenca(x, geo_df_cuencas))

datadumm.to_csv("data_mediciones_dummie_y_cuencas.csv",index=False)


# print(datadumm['Cumple Limites Ia'].value_counts()) # Tenemos 15.821 mediciones que son True o False osea que sabemos si estan ok, son muy pocas